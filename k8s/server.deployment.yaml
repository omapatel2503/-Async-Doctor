apiVersion: apps/v1
kind: Deployment
metadata:
  name: server
  namespace: async-doctor
  labels: { app: async-doctor, tier: server }
spec:
  replicas: 1
  selector: { matchLabels: { app: async-doctor, tier: server } }
  template:
    metadata:
      labels: { app: async-doctor, tier: server }
    spec:
      containers:
        - name: server
          # Cloud Build will substitute this image on deploy
          image: REG-docker.pkg.dev/PROJ/REPO/server:SHORT_SHA
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 4000
          envFrom:
            - configMapRef: { name: server-config }
            - secretRef:    { name: ollama-secret }
          env:
            - name: OLLAMA_API_KEY
              valueFrom:
                secretKeyRef:
                  name: ollama-secret
                  key: OLLAMA_API_KEY
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: ollama-secret
                  key: DATABASE_URL
          volumeMounts:
            - name: jobs
              mountPath: /app/jobs
          resources:
            requests: { cpu: "250m", memory: "512Mi" }
            limits:   { cpu: "1000m", memory: "1Gi" }
      volumes:
        - name: jobs
          persistentVolumeClaim:
            claimName: jobs-pvc